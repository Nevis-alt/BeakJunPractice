@page "/typing-game"
@inject IJSRuntime JS
@inject HttpClient Http

<h1 class="mb-4">리듬 타이핑 게임</h1>

<audio id="music" src="music/song1.mp3"></audio>

<div class="mb-3">
    <button @onclick="Play" class="btn btn-primary">▶ 재생</button>
    <button @onclick="Pause" class="btn btn-secondary">⏸ 일시정지</button>
</div>
@if (TimingList == null)
{
    <p>⏳ 로딩 중...</p>
}
else if (currentIndex < TimingList.Count)
{
    <div class="p-4 border rounded bg-light shadow-sm mb-4">
        <h3>현재 글자: <span class="text-primary">@TimingList[currentIndex].Text</span></h3>
        <p class="text-muted">
            시간 (@TimingList[currentIndex].Start.ToString("F2") ~ @TimingList[currentIndex].End.ToString("F2"))
        </p>
        <p class="fs-5">@message</p>
    </div>

    <input class="form-control form-control-lg"
           placeholder="입력하세요..."
           @oninput="OnInput"
           value="@userInput"
           autofocus />
}
else
{
    <div class="alert alert-success">
        <h3>🎉 완료!</h3>
        <p>모든 가사를 입력했습니다!</p>
    </div>
}

@code {

    // ====== 가사 데이터 예제 ======
    record LyricSegment(double Start, double End, string Text);

    private List<LyricSegment> TimingList;
    private PeriodicTimer loop;
    /*
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            TimingList = await Http.GetFromJsonAsync<List<LyricSegment>>("timing/song1.json");

            loop = new PeriodicTimer(TimeSpan.FromMilliseconds(16));

            _ = Task.Run(async () =>
            {
                while (await loop.WaitForNextTickAsync())
                    await CheckTiming();
            });
        }
    }
    */
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                TimingList = await Http.GetFromJsonAsync<List<LyricSegment>>(
                    "timing/song1.json"
                );
            }
            catch (Exception ex)
            {
                Console.WriteLine("JSON LOAD ERROR: " + ex);
            }

            StateHasChanged();   // 화면 갱신
        }
    }


    private int currentIndex = 0;
    private string message = "";
    private string userInput = "";

    // ======= 오디오 제어 =======
    private async Task Play()
    {
        await JS.InvokeVoidAsync("music_controls.play");
    }

    private async Task Pause()
    {
        await JS.InvokeVoidAsync("music_controls.pause");
    }
    private async Task SetAudio(string file)
    {
        await JS.InvokeVoidAsync("music_controls.setSource", file);
    }


    // ======= 타이밍 검사 로직 =======
    private async Task<double> GetCurrentTime()
    {
        return await JS.InvokeAsync<double>("music_controls.getCurrentTime");
    }

    private async Task CheckTiming()
    {
        if (TimingList == null || TimingList.Count == 0)
            return;
        if (currentIndex >= TimingList.Count)
            return;

        double now = await GetCurrentTime();
        var note = TimingList[currentIndex];

        // 시간이 지나면 MISS 처리
        if (now > note.End)
        {
            message = $"{note.Text} → MISS";
            currentIndex++;
            userInput = "";

            InvokeAsync(StateHasChanged);
        }
    }

    // ======= 입력 처리 =======
    private async void OnInput(ChangeEventArgs e)
    {
        if (TimingList == null || currentIndex >= TimingList.Count)
            return;
        userInput = e.Value?.ToString() ?? "";
        if (currentIndex >= TimingList.Count) return;

        double now = await GetCurrentTime();
        var note = TimingList[currentIndex];

        // 아직 타이밍이 오지 않음
        if (now < note.Start) return;

        // 정확 입력
        if (userInput == note.Text)
        {
            message = $"{note.Text} → HIT!";
            currentIndex++;
            userInput = "";
            InvokeAsync(StateHasChanged);
            return;
        }

        // 시간이 지났는데 틀렸으면 MISS
        if (now > note.End)
        {
            message = $"{note.Text} → MISS";
            currentIndex++;
            userInput = "";
            InvokeAsync(StateHasChanged);
        }
    }
}
